<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commerce Semester I - MCQ Preparation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #10B981; /* Emerald 500 */
            --secondary-color: #1F2937; /* Gray 800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }
        .scrollable-subjects {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scrollable-subjects::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .option-button {
            transition: all 0.2s ease;
        }
        .selected-option {
            border-color: var(--primary-color) !important;
            background-color: #ECFDF5 !important;
        }
        .correct-answer {
            background-color: #D1FAE5 !important; /* Light green for correct */
            border-color: #059669 !important;
        }
        .incorrect-answer {
            background-color: #FEE2E2 !important; /* Light red for incorrect */
            border-color: #EF4444 !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 md:text-2xl">Commerce I Prep Tool</h1>
            <div class="flex items-center space-x-4">
                <button id="language-switch-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-150">
                    Switch to Hindi
                </button>
            </div>
        </div>
    </header>

    <main class="flex flex-col md:flex-row flex-grow max-w-7xl mx-auto w-full p-4 space-y-4 md:space-y-0 md:space-x-4">

        <!-- Subject and Unit Navigation (Sidebar/Topbar on Mobile) -->
        <aside class="w-full md:w-64 bg-white p-4 rounded-xl shadow-lg flex-shrink-0">
            <h2 id="selector-title" class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Select Subject</h2>
            <div id="subject-list" class="flex md:flex-col space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto scrollable-subjects pb-2">
                <!-- Subject buttons will be injected here -->
            </div>

            <div id="unit-section" class="mt-4 pt-4 border-t hidden">
                <h3 id="unit-title" class="text-md font-semibold text-gray-700 mb-3">Select Unit</h3>
                <div id="unit-list" class="flex md:flex-col space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto scrollable-subjects">
                    <!-- Unit buttons will be injected here -->
                </div>
            </div>
        </aside>

        <!-- Main Content Area (Question) -->
        <section class="flex-grow bg-white p-6 rounded-xl shadow-lg">
            <div id="quiz-container">
                <p id="welcome-message" class="text-gray-600 text-lg py-12 text-center">
                    Welcome! Please select a subject and a unit to begin your MCQ test.
                </p>
                <!-- Loading State for Dynamic Questions -->
                <div id="loading-questions" class="hidden p-6 text-center text-indigo-600">
                    <svg class="animate-spin mx-auto h-8 w-8 text-indigo-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-3 font-medium">Generating new questions with Gemini AI...</p>
                </div>
            </div>

            <div id="question-card" class="hidden">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span id="current-unit-info" class="text-sm font-medium text-indigo-600"></span>
                    <span id="question-counter" class="text-sm font-medium text-gray-500"></span>
                </div>

                <!-- Question Area -->
                <p id="question-text" class="text-gray-800 text-xl font-medium mb-6"></p>

                <!-- Options -->
                <div id="options-container" class="space-y-3">
                    <!-- Options will be injected here -->
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex flex-col md:flex-row md:justify-between md:items-center space-y-3 md:space-y-0 md:space-x-3">
                    <div class="flex space-x-3">
                        <button id="check-answer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md flex-grow md:flex-grow-0" disabled>
                            Check Answer
                        </button>
                        <button id="explanation-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md hidden flex-grow md:flex-grow-0">
                            Show Explanation
                        </button>
                    </div>

                    <!-- Gemini AI Button (Requires fetch API logic) -->
                    <button id="gemini-ai-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-3.5-7.5a.5.5 0 000 1h7a.5.5 0 000-1h-7z" clip-rule="evenodd"></path><path d="M10 2a8 8 0 00-6.91 11.96l-.76.76a.5.5 0 00.707.707l.76-.76A8 8 0 1010 2zM7 11.5a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5z" fill="white"></path></svg>
                        <span id="gemini-btn-text">Analyze with Gemini AI</span>
                    </button>
                </div>

                <!-- Feedback Area -->
                <div id="feedback-area" class="mt-6 space-y-4">
                    <!-- Answer Result Message -->
                    <div id="result-message" class="p-3 rounded-lg font-medium hidden"></div>

                    <!-- Explanation Block -->
                    <div id="explanation-block" class="p-4 bg-gray-100 rounded-lg border-l-4 border-yellow-500 hidden">
                        <h4 class="font-bold text-gray-700 mb-2" id="explanation-heading">Explanation:</h4>
                        <p id="explanation-text" class="text-gray-600"></p>
                    </div>

                    <!-- Gemini AI Analysis Block -->
                    <div id="gemini-analysis-block" class="p-4 bg-emerald-50 rounded-lg border-l-4 border-emerald-500 hidden">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1h-2V4H7v1H5V4zM4 6h12v11a3 3 0 01-3 3H7a3 3 0 01-3-3V6zm2 4a1 1 0 00-1 1v2a1 1 0 001 1h8a1 1 0 001-1v-2a1 1 0 00-1-1H6z"></path></svg>
                            <span id="gemini-analysis-heading">Gemini AI Analysis:</span>
                        </h4>
                        <div id="gemini-analysis-content" class="text-gray-600">
                            <!-- Analysis content and loading spinner will be placed here -->
                        </div>
                        <div id="gemini-sources" class="mt-3 text-xs text-gray-500 hidden">
                            <h5 id="sources-heading" class="font-semibold mb-1">Sources:</h5>
                            <ul id="sources-list" class="list-disc list-inside space-y-1"></ul>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="mt-8 flex justify-end">
                    <button id="next-question-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md hidden">
                        Next Question
                    </button>
                </div>
            </div>
        </section>

    </main>

    <footer class="p-4 text-center text-sm text-gray-500 mt-auto">
        &copy; 2025 Commerce Prep Tool. AI Analysis powered by Gemini API.
    </footer>

    <script>
        // --- DATA STRUCTURE (Only for navigation and translation) ---
        // Hardcoded list of subjects and units for button rendering
        const quizData = {
            english: {
                'Business Organisation': {
                    'Unit 1: Fundamentals': [], 'Unit 2: Forms of Business': [], 'Unit 3: Management Basics': [], 'Unit 4: Social Responsibility': [], 'Unit 5: Aids to Trade': []
                },
                'Business Statistics': {
                    'Unit 1: Central Tendency': [], 'Unit 2: Dispersion': [], 'Unit 3: Probability': [], 'Unit 4: Correlation & Regression': [], 'Unit 5: Index Numbers': []
                },
                'Business Communication': {
                    'Unit 1: Fundamentals & Process': [], 'Unit 2: The 7 Cs': [], 'Unit 3: Barriers': [], 'Unit 4: Written Communication': [], 'Unit 5: Non-Verbal Communication': []
                },
                'Introduction to Computer Applications': {
                    'Unit 1: Hardware & Software': [], 'Unit 2: Input/Output Devices': [], 'Unit 3: Memory & Storage': [], 'Unit 4: Operating System & Utility': [], 'Unit 5: Internet & Networking': []
                },
            },
            hindi: {
                '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§∏‡§Ç‡§ó‡§†‡§®': {
                    '‡§á‡§ï‡§æ‡§à 1: ‡§Æ‡•Ç‡§≤ ‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§Ç‡§§': [], '‡§á‡§ï‡§æ‡§à 2: ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™': [], '‡§á‡§ï‡§æ‡§à 3: ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡•á ‡§Æ‡•Ç‡§≤ ‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§Ç‡§§': [], '‡§á‡§ï‡§æ‡§à 4: ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä': [], '‡§á‡§ï‡§æ‡§à 5: ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§ï‡•á ‡§∏‡§π‡§æ‡§Ø‡§ï': []
                },
                '‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§∏‡§æ‡§Ç‡§ñ‡•ç‡§Ø‡§ø‡§ï‡•Ä': {
                    '‡§á‡§ï‡§æ‡§à 1: ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø': [], '‡§á‡§ï‡§æ‡§à 2: ‡§´‡•à‡§≤‡§æ‡§µ (Dispersion)': [], '‡§á‡§ï‡§æ‡§à 3: ‡§™‡•ç‡§∞‡§æ‡§Ø‡§ø‡§ï‡§§‡§æ': [], '‡§á‡§ï‡§æ‡§à 4: ‡§∏‡§π‡§∏‡§Ç‡§¨‡§Ç‡§ß ‡§î‡§∞ ‡§™‡•ç‡§∞‡§§‡§ø‡§ó‡§Æ‡§®': [], '‡§á‡§ï‡§æ‡§à 5: ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§è‡§Å': []
                },
                '‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§∏‡§Ç‡§ö‡§æ‡§∞': {
                    '‡§á‡§ï‡§æ‡§à 1: ‡§Æ‡•Ç‡§≤ ‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§Ç‡§§ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ': [], '‡§á‡§ï‡§æ‡§à 2: 7 C\'s': [], '‡§á‡§ï‡§æ‡§à 3: ‡§¨‡§æ‡§ß‡§æ‡§è‡§Å': [], '‡§á‡§ï‡§æ‡§à 4: ‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§∏‡§Ç‡§ö‡§æ‡§∞': [], '‡§á‡§ï‡§æ‡§à 5: ‡§ó‡•à‡§∞-‡§Æ‡•å‡§ñ‡§ø‡§ï ‡§∏‡§Ç‡§ö‡§æ‡§∞': []
                },
                '‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§∞‡§ø‡§ö‡§Ø': {
                    '‡§á‡§ï‡§æ‡§à 1: ‡§π‡§æ‡§∞‡•ç‡§°‡§µ‡•á‡§Ø‡§∞ ‡§î‡§∞ ‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞': [], '‡§á‡§ï‡§æ‡§à 2: ‡§á‡§®‡§™‡•Å‡§ü/‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§°‡§ø‡§µ‡§æ‡§á‡§∏': [], '‡§á‡§ï‡§æ‡§à 3: ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§î‡§∞ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú': [], '‡§á‡§ï‡§æ‡§à 4: ‡§ë‡§™‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§î‡§∞ ‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä': [], '‡§á‡§ï‡§æ‡§à 5: ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§î‡§∞ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï‡§ø‡§Ç‡§ó': []
                },
            }
        };

        // --- GLOBAL STATE ---
        let currentLanguage = 'english';
        let currentSubject = '';
        let currentUnit = '';
        let currentQuestionIndex = 0;
        let selectedOptionIndex = null;
        let questionSet = []; // Stores the dynamically generated questions

        const API_KEY = ""; // Placeholder for the API Key
        const NUMBER_OF_QUESTIONS = 5;

        // --- DOM Elements ---
        const dom = {
            langSwitchBtn: document.getElementById('language-switch-btn'),
            subjectList: document.getElementById('subject-list'),
            unitSection: document.getElementById('unit-section'),
            unitList: document.getElementById('unit-list'),
            quizContainer: document.getElementById('quiz-container'),
            welcomeMessage: document.getElementById('welcome-message'),
            loadingQuestions: document.getElementById('loading-questions'), // New element for loading
            questionCard: document.getElementById('question-card'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            checkAnswerBtn: document.getElementById('check-answer-btn'),
            explanationBtn: document.getElementById('explanation-btn'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            geminiAiBtn: document.getElementById('gemini-ai-btn'),
            geminiBtnText: document.getElementById('gemini-btn-text'),
            feedbackArea: document.getElementById('feedback-area'),
            resultMessage: document.getElementById('result-message'),
            explanationBlock: document.getElementById('explanation-block'),
            explanationText: document.getElementById('explanation-text'),
            geminiAnalysisBlock: document.getElementById('gemini-analysis-block'),
            geminiAnalysisContent: document.getElementById('gemini-analysis-content'),
            currentUnitInfo: document.getElementById('current-unit-info'),
            questionCounter: document.getElementById('question-counter'),
            selectorTitle: document.getElementById('selector-title'),
            unitTitle: document.getElementById('unit-title'),
            geminiAnalysisHeading: document.getElementById('gemini-analysis-heading'),
            sourcesHeading: document.getElementById('sources-heading'),
            sourcesList: document.getElementById('sources-list'),
        };

        // --- UTILITY FUNCTIONS ---

        // Helper function for exponential backoff retry logic
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            // Rate limit hit, wait with exponential backoff
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error;
                    // Wait before the next retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- QUESTION GENERATION LOGIC ---

        async function generateQuestions(subject, unit, language) {
            dom.welcomeMessage.classList.add('hidden');
            dom.questionCard.classList.add('hidden');
            dom.loadingQuestions.classList.remove('hidden');

            const isEnglish = language === 'english';
            const targetLang = isEnglish ? 'English' : 'Hindi';

            const systemPrompt = `You are a specialist in creating challenging and concept-based Multiple Choice Questions (MCQs) for 1st-semester undergraduate commerce students.
                Your task is to generate exactly ${NUMBER_OF_QUESTIONS} MCQs for the subject "${subject}" under the unit "${unit}".
                Each question must have 4 distinct options and one clear correct answer.
                Provide a detailed, accurate explanation for why the chosen answer is correct.
                The entire response must be a valid JSON array matching the provided schema, and all text (question, options, explanation) must be in ${targetLang}.`;

            const userQuery = `Generate ${NUMBER_OF_QUESTIONS} fresh, challenging MCQs for the topic: ${subject} - ${unit}. Ensure all output is in ${targetLang}.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        description: `A list of ${NUMBER_OF_QUESTIONS} multiple-choice questions.`,
                        items: {
                            type: "OBJECT",
                            properties: {
                                "q": { "type": "STRING", "description": "The question text." },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" },
                                    "description": "Four possible answers for the MCQ."
                                },
                                "ans": { "type": "INTEGER", "description": "The zero-based index of the correct option (0, 1, 2, or 3)." },
                                "exp": { "type": "STRING", "description": "A detailed explanation for the correct answer." }
                            },
                            required: ["q", "options", "ans", "exp"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const parsedQuestions = JSON.parse(jsonText);
                    if (Array.isArray(parsedQuestions) && parsedQuestions.length > 0) {
                        questionSet = parsedQuestions;
                        currentQuestionIndex = 0;
                        dom.loadingQuestions.classList.add('hidden');
                        dom.questionCard.classList.remove('hidden');
                        renderQuestion();
                        return;
                    }
                }
                throw new Error("Invalid or empty JSON response from API.");

            } catch (error) {
                console.error("Question Generation Error:", error);
                dom.loadingQuestions.classList.add('hidden');
                dom.welcomeMessage.classList.remove('hidden');
                dom.welcomeMessage.textContent = isEnglish ?
                    `Error generating questions for ${unit}. Please try again.` :
                    `${unit} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`;
            }
        }


        // --- GEMINI AI ANALYSIS LOGIC (Kept largely the same) ---

        async function analyzeQuestionWithGemini() {
            if (!currentSubject || !currentUnit || !questionSet.length) return;

            const currentQuestion = questionSet[currentQuestionIndex];
            const questionText = currentQuestion.q + ' Options: ' + currentQuestion.options.join(', ') + '. Correct answer index: ' + currentQuestion.ans;

            // Update UI for loading state
            dom.geminiAnalysisBlock.classList.remove('hidden');
            dom.geminiAnalysisContent.innerHTML = '<div class="flex items-center space-x-2 text-emerald-600"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Analyzing... This may take a moment.</span></div>';
            dom.geminiAiBtn.disabled = true;
            dom.geminiAiBtn.classList.add('opacity-50', 'cursor-not-allowed');
            dom.sourcesList.innerHTML = '';
            dom.geminiSources.classList.add('hidden');

            const systemPrompt = `You are an expert commerce and finance tutor for first-semester university students. Your goal is to provide a concise, single-paragraph analysis of the multiple-choice question provided.
                1. Clearly explain the core concept being tested.
                2. Explain why the correct option is the definitive answer.
                3. Briefly explain why the other options are incorrect.
                4. Maintain a professional and encouraging tone.`;

            const userQuery = `Analyze the following commerce MCQ from the unit "${currentSubject} - ${currentUnit}". The question is: "${questionText}". Provide the analysis in ${currentLanguage === 'english' ? 'English' : 'Hindi'}.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    dom.geminiAnalysisContent.innerHTML = `<p class="text-gray-700">${text}</p>`;

                    // Extract and display grounding sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        dom.sourcesList.innerHTML = sources.map(source =>
                            `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">${source.title || 'Source Link'}</a></li>`
                        ).join('');
                        dom.geminiSources.classList.remove('hidden');
                    }
                } else {
                    dom.geminiAnalysisContent.innerHTML = '<p class="text-red-600">AI analysis failed. Please try again later.</p>';
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                dom.geminiAnalysisContent.innerHTML = '<p class="text-red-600">Failed to connect to the AI service. Check network or API key setup.</p>';
            } finally {
                // Re-enable button
                dom.geminiAiBtn.disabled = false;
                dom.geminiAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }


        // --- RENDERING FUNCTIONS ---

        function updateTexts() {
            const isEnglish = currentLanguage === 'english';
            dom.langSwitchBtn.textContent = isEnglish ? '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç' : 'Switch to English';
            dom.selectorTitle.textContent = isEnglish ? 'Select Subject' : '‡§µ‡§ø‡§∑‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç';
            dom.unitTitle.textContent = isEnglish ? 'Select Unit' : '‡§á‡§ï‡§æ‡§à ‡§ö‡•Å‡§®‡•á‡§Ç';
            dom.welcomeMessage.textContent = isEnglish ? 'Welcome! Please select a subject and a unit to begin your MCQ test.' : '‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ MCQ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§µ‡§ø‡§∑‡§Ø ‡§î‡§∞ ‡§è‡§ï ‡§á‡§ï‡§æ‡§à ‡§ö‡•Å‡§®‡•á‡§Ç‡•§';
            dom.checkAnswerBtn.textContent = isEnglish ? 'Check Answer' : '‡§â‡§§‡•ç‡§§‡§∞ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç';
            dom.explanationBtn.textContent = isEnglish ? 'Show Explanation' : '‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å';
            dom.nextQuestionBtn.textContent = isEnglish ? 'Next Question' : '‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®';
            dom.geminiBtnText.textContent = isEnglish ? 'Analyze with Gemini AI' : '‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä ‡§è‡§Ü‡§à ‡§∏‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç';
            dom.explanationHeading.textContent = isEnglish ? 'Explanation:' : '‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£:';
            dom.geminiAnalysisHeading.textContent = isEnglish ? 'Gemini AI Analysis:' : '‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä ‡§è‡§Ü‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£:';
            dom.sourcesHeading.textContent = isEnglish ? 'Sources:' : '‡§∏‡•ç‡§∞‡•ã‡§§:';
        }

        function renderSubjects() {
            const subjects = Object.keys(quizData[currentLanguage]);
            dom.subjectList.innerHTML = '';
            dom.unitSection.classList.add('hidden');
            dom.questionCard.classList.add('hidden');
            dom.loadingQuestions.classList.add('hidden');
            dom.welcomeMessage.classList.remove('hidden');

            subjects.forEach(subject => {
                const isActive = subject === currentSubject;
                const button = document.createElement('button');
                button.textContent = subject;
                button.className = `w-full md:w-auto text-left py-2 px-4 rounded-lg font-medium transition duration-150 ${isActive ? 'bg-indigo-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-indigo-100 hover:text-indigo-600'}`;
                button.onclick = () => selectSubject(subject);
                dom.subjectList.appendChild(button);
            });

            if (currentSubject) {
                // Rerender units if a subject is already selected
                dom.welcomeMessage.classList.add('hidden');
                dom.unitSection.classList.remove('hidden');
                renderUnits(currentSubject);
            } else {
                currentUnit = '';
            }
        }

        function renderUnits(subject) {
            const units = Object.keys(quizData[currentLanguage][subject]);
            dom.unitList.innerHTML = '';

            units.forEach(unit => {
                const isActive = unit === currentUnit;
                const button = document.createElement('button');
                button.textContent = unit;
                button.className = `w-full md:w-auto text-left py-2 px-4 rounded-lg text-sm transition duration-150 ${isActive ? 'bg-indigo-400 text-white shadow-sm' : 'bg-white border border-gray-200 text-gray-700 hover:bg-indigo-50 hover:text-indigo-500'}`;
                button.onclick = () => selectUnit(unit);
                dom.unitList.appendChild(button);
            });

            if (currentUnit && questionSet.length > 0) {
                // Only show question card if questions are already generated
                dom.questionCard.classList.remove('hidden');
                renderQuestion();
            } else if (currentUnit) {
                // If unit is selected but questions aren't loaded (first selection or language switch)
                generateQuestions(currentSubject, currentUnit, currentLanguage);
            }
        }

        function renderQuestion() {
            if (questionSet.length === 0) return;

            const qData = questionSet[currentQuestionIndex];
            const isEnglish = currentLanguage === 'english';
            const totalQuestions = questionSet.length;

            // Reset UI
            selectedOptionIndex = null;
            dom.feedbackArea.classList.remove('pointer-events-none');
            dom.resultMessage.classList.add('hidden');
            dom.explanationBlock.classList.add('hidden');
            dom.nextQuestionBtn.classList.add('hidden');
            dom.checkAnswerBtn.classList.remove('hidden');
            dom.explanationBtn.classList.add('hidden');
            dom.checkAnswerBtn.disabled = true;
            dom.checkAnswerBtn.classList.add('opacity-50', 'cursor-not-allowed');
            dom.geminiAnalysisBlock.classList.add('hidden');
            dom.geminiAiBtn.disabled = false;
            dom.geminiAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Set texts
            dom.currentUnitInfo.textContent = `${currentSubject} / ${currentUnit}`;
            dom.questionCounter.textContent = isEnglish ? `Question ${currentQuestionIndex + 1} of ${totalQuestions}` : `‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${currentQuestionIndex + 1} / ${totalQuestions}`;
            dom.questionText.textContent = qData.q;
            dom.optionsContainer.innerHTML = '';

            // Render options
            qData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.dataset.index = index;
                button.className = 'option-button w-full text-left p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 text-gray-800 transition duration-150';
                button.onclick = handleOptionSelection;
                dom.optionsContainer.appendChild(button);
            });
        }

        function handleOptionSelection(event) {
            const allOptions = dom.optionsContainer.querySelectorAll('.option-button');
            const clickedButton = event.target.closest('.option-button');

            if (!clickedButton) return;

            // Deselect all and select the clicked one
            allOptions.forEach(btn => btn.classList.remove('selected-option', 'correct-answer', 'incorrect-answer', 'font-bold'));
            clickedButton.classList.add('selected-option');

            selectedOptionIndex = parseInt(clickedButton.dataset.index);
            dom.checkAnswerBtn.disabled = false;
            dom.checkAnswerBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function checkAnswer() {
            if (selectedOptionIndex === null) return;

            const currentQuestion = questionSet[currentQuestionIndex];
            const correctIndex = currentQuestion.ans;
            const isCorrect = selectedOptionIndex === correctIndex;
            const options = dom.optionsContainer.querySelectorAll('.option-button');
            const isEnglish = currentLanguage === 'english';

            // Disable further interaction
            options.forEach(btn => btn.onclick = null);
            dom.checkAnswerBtn.classList.add('hidden');
            dom.explanationBtn.classList.remove('hidden');

            // Show result message
            dom.resultMessage.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-800', 'text-green-800');
            if (isCorrect) {
                dom.resultMessage.classList.add('bg-green-100', 'text-green-800');
                dom.resultMessage.textContent = isEnglish ? 'Result: Correct Answer! üéâ' : '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ: ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞! üéâ';
            } else {
                dom.resultMessage.classList.add('bg-red-100', 'text-red-800');
                dom.resultMessage.textContent = isEnglish ? 'Result: Incorrect. Review the explanation.' : '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ: ‡§ó‡§≤‡§§‡•§ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£ ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§';
            }

            // Highlight correct and incorrect options
            options.forEach((btn, index) => {
                btn.classList.remove('selected-option');
                if (index === correctIndex) {
                    btn.classList.add('correct-answer', 'font-bold');
                } else if (index === selectedOptionIndex && !isCorrect) {
                    btn.classList.add('incorrect-answer', 'font-bold');
                }
            });

            // Show next question button
            dom.nextQuestionBtn.classList.remove('hidden');
        }

        function showExplanation() {
            const currentQuestion = questionSet[currentQuestionIndex];
            dom.explanationText.textContent = currentQuestion.exp;
            dom.explanationBlock.classList.toggle('hidden');
            dom.explanationBtn.textContent = dom.explanationBlock.classList.contains('hidden') ?
                (currentLanguage === 'english' ? 'Show Explanation' : '‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å') :
                (currentLanguage === 'english' ? 'Hide Explanation' : '‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å');
        }

        // --- CONTROLLERS ---

        function selectSubject(subject) {
            currentSubject = subject;
            currentUnit = ''; // Reset unit when subject changes
            questionSet = []; // Clear current questions
            renderSubjects(); // Rerender subjects to highlight the active one
            dom.unitSection.classList.remove('hidden');
            dom.questionCard.classList.add('hidden');
        }

        function selectUnit(unit) {
            if (currentUnit === unit) return; // Avoid re-generating questions if same unit is clicked

            currentUnit = unit;
            questionSet = []; // Ensure old questions are cleared
            renderSubjects(); // Rerender units to highlight the active one

            // Trigger dynamic question generation
            generateQuestions(currentSubject, currentUnit, currentLanguage);
        }

        function goToNextQuestion() {
            dom.resultMessage.classList.add('hidden');
            dom.explanationBlock.classList.add('hidden');
            dom.geminiAnalysisBlock.classList.add('hidden');
            dom.nextQuestionBtn.classList.add('hidden');

            if (currentQuestionIndex < questionSet.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                // End of quiz for this unit
                dom.questionCard.classList.add('hidden');
                dom.welcomeMessage.classList.remove('hidden');
                dom.welcomeMessage.textContent = currentLanguage === 'english' ?
                    `You have completed Unit ${currentUnit} of ${currentSubject}! Select another unit or subject to generate a new test.` :
                    `‡§Ü‡§™‡§®‡•á ${currentSubject} ‡§ï‡•Ä ‡§á‡§ï‡§æ‡§à ${currentUnit} ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞ ‡§≤‡•Ä ‡§π‡•à! ‡§®‡§Ø‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ö‡§®‡•ç‡§Ø ‡§á‡§ï‡§æ‡§à ‡§Ø‡§æ ‡§µ‡§ø‡§∑‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç‡•§`;
                currentUnit = ''; // Reset unit
                questionSet = []; // Clear questions
                renderSubjects(); // Go back to subject selection view
            }
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'english' ? 'hindi' : 'english';
            // Reset state to force regeneration in new language
            currentSubject = '';
            currentUnit = '';
            questionSet = [];

            updateTexts();
            renderSubjects(); // Re-render everything in the new language
        }

        // --- EVENT LISTENERS & INITIALIZATION ---

        dom.langSwitchBtn.addEventListener('click', toggleLanguage);
        dom.checkAnswerBtn.addEventListener('click', checkAnswer);
        dom.nextQuestionBtn.addEventListener('click', goToNextQuestion);
        dom.explanationBtn.addEventListener('click', showExplanation);
        dom.geminiAiBtn.addEventListener('click', analyzeQuestionWithGemini);


        // Initial setup - Changed to IIFE for immediate execution
        (function init() {
            updateTexts();
            renderSubjects();
        })();

    </script>
</body>
</html>
